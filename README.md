# Go Loyalty Service

Микросервисная система лояльности для интернет-магазина, реализованная на Go. Проект состоит из двух независимых сервисов, работающих в связке для управления накопительными баллами пользователей.

## Что это за проект

Система позволяет пользователям регистрироваться, загружать номера заказов и получать баллы лояльности за покупки. Баллы можно накапливать и тратить на последующие заказы. Вся логика реализована через REST API с аутентификацией и авторизацией.

## Архитектура

Проект построен по принципу микросервисной архитектуры:

- **Gophermart** — основной сервис лояльности, обрабатывает запросы пользователей
- **Accrual** — сервис расчета начислений, обрабатывает заказы и рассчитывает вознаграждения

Сервисы общаются асинхронно: Gophermart отправляет заказы в Accrual, а затем опрашивает статус через worker pool.

## Основной функционал

### Gophermart (API лояльности)

- **Регистрация и аутентификация** — JWT-based авторизация с хешированием паролей
- **Управление заказами** — загрузка номеров заказов с валидацией по алгоритму Луна
- **Баланс** — просмотр текущего баланса и истории списаний
- **Списание баллов** — частичная или полная оплата заказов накопленными баллами
- **История операций** — список всех загруженных заказов с их статусами и начислениями

### Accrual (Расчет начислений)

- **Регистрация заказов** — прием заказов с составом товаров для расчета
- **Правила вознаграждений** — гибкая система правил (процентные и фиксированные начисления)
- **Расчет баллов** — автоматический поиск совпадений товаров по ключевым словам и начисление баллов
- **Статусы обработки** — отслеживание статусов заказов (NEW, PROCESSING, PROCESSED, INVALID)

## Технические решения

### Backend

- **Go 1.24** — основной язык разработки
- **Chi Router** — легковесный HTTP роутер
- **PostgreSQL** — основное хранилище данных
- **JWT** — аутентификация пользователей
- **Zap** — структурированное логирование
- **Squirrel** — построитель SQL-запросов

### Архитектурные паттерны

- **Repository Pattern** — абстракция доступа к данным
- **Service Layer** — бизнес-логика отделена от HTTP-обработчиков
- **Worker Pool** — асинхронный опрос внешнего сервиса с обработкой rate limiting
- **Graceful Shutdown** — корректное завершение работы с ожиданием завершения горутин

### Инфраструктура

- **Docker Compose** — оркестрация всех сервисов
- **Database Migrations** — версионирование схемы БД
- **Health Checks** — проверка готовности сервисов
- **Compression** — сжатие HTTP-ответов

## Запуск проекта

### Требования

- Go 1.24+
- Docker и Docker Compose
- PostgreSQL 15+ (или через Docker)

### Быстрый старт

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd go-loyalty-service
```

2. Создайте `.env` файл с настройками (примеры в `docker-compose.yml`)

3. Запустите через Docker Compose:
```bash
docker-compose up -d
```

Сервисы будут доступны:
- Gophermart: `http://localhost:8080`
- Accrual: `http://localhost:8081`

### Локальный запуск

Для запуска без Docker:

1. Запустите PostgreSQL локально или через Docker
2. Примените миграции из `migrations/`
3. Запустите сервисы:
```bash
# Gophermart
go run cmd/gophermart/main.go -a :8080 -d "postgres://..." -r "http://localhost:8081"

# Accrual
go run cmd/accrual/main.go -a :8081 -d "postgres://..."
```

## API Endpoints

### Gophermart

- `POST /api/user/register` — регистрация
- `POST /api/user/login` — вход
- `POST /api/user/orders` — загрузка номера заказа
- `GET /api/user/orders` — список заказов пользователя
- `GET /api/user/balance` — текущий баланс
- `POST /api/user/balance/withdraw` — списание баллов
- `GET /api/user/withdrawals` — история списаний

### Accrual

- `GET /api/orders/{number}` — информация о расчете начислений
- `POST /api/orders` — регистрация заказа
- `POST /api/goods` — регистрация правила вознаграждения

Подробная документация API доступна в `SPECIFICATION.md`.

## Особенности реализации

- **Асинхронная обработка заказов** — worker pool опрашивает Accrual сервис в фоне, обрабатывая rate limiting и ошибки сети
- **Валидация данных** — проверка номеров заказов по алгоритму Луна, валидация баланса перед списанием
- **Безопасность** — пароли хешируются с помощью bcrypt, JWT токены для сессий
- **Обработка ошибок** — централизованная обработка ошибок с понятными HTTP-кодами
- **Тестирование** — unit-тесты для сервисов и интеграционные тесты для API

## Структура проекта

```
go-loyalty-service/
├── cmd/
│   ├── gophermart/    # Точка входа основного сервиса
│   └── accrual/       # Точка входа сервиса расчетов
├── internal/
│   ├── gophermart/    # Логика основного сервиса
│   ├── accrual/       # Логика сервиса расчетов
│   ├── config/        # Конфигурация
│   └── logger/        # Логирование
├── migrations/        # SQL миграции
└── pkg/              # Переиспользуемые пакеты
```

---

Проект разработан в рамках обучения Go-разработке с фокусом на практическое применение микросервисной архитектуры и современных паттернов разработки.
